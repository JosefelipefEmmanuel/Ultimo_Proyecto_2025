<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UMG | Analizador L√©xico Multiling√ºe</title>

  <!-- üîó Dependencias -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet" />

  <style>
    body {
      background: linear-gradient(135deg, #002244, #004b8d);
      color: #fff;
      font-family: 'Poppins', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: rgba(0, 0, 0, 0.25);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 1.3rem;
      letter-spacing: 1px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    }

    main {
      flex: 1;
      padding: 2rem;
    }

    .card {
      background: rgba(255, 255, 255, 0.12);
      border: none;
      backdrop-filter: blur(8px);
      color: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .btn-primary {
      background-color: #00e0ff;
      border: none;
      color: #000;
      font-weight: 600;
    }

    .btn-primary:hover {
      background-color: #00b3cc;
    }

    .btn-success {
      background-color: #28a745;
      border: none;
      font-weight: 600;
    }

    .btn-success:hover {
      background-color: #218838;
    }

    .btn-logout {
      background-color: #dc3545;
      border: none;
      color: #fff;
      font-weight: 600;
      padding: 0.4rem 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      transition: background 0.3s;
    }

    .btn-logout:hover {
      background-color: #bb2d3b;
    }

    footer {
      background: rgba(0, 0, 0, 0.25);
      text-align: center;
      padding: 0.8rem;
      font-size: 0.9rem;
      color: #ccc;
    }

    .spinner-border {
      width: 3rem;
      height: 3rem;
    }

    #fileProgress {
      display: none;
    }
  </style>
</head>

<body>
  <header>
    üöÄ UMG ‚Äî Analizador L√©xico Multiling√ºe
    <button id="btnLogout" class="btn-logout">
      <i class="fas fa-sign-out-alt me-1"></i> Cerrar sesi√≥n
    </button>
  </header>

  <main class="container">
    <div id="info-usuario" class="alert alert-success text-center" style="display:none;"></div>

    <!-- Formulario -->
    <div class="card p-4 mb-4">
      <h4 class="text-center mb-3">üìÅ Cargar Archivo de Texto</h4>

      <form id="formAnalisis" enctype="multipart/form-data">
        <div class="row g-3 align-items-center">
          <div class="col-md-5">
            <label class="form-label fw-semibold">Selecciona archivo .txt</label>
            <input type="file" name="archivo" accept=".txt" class="form-control" required />
            <div id="fileProgress" class="progress mt-2">
              <div id="fileProgressBar" class="progress-bar bg-success" style="width:0%">0%</div>
            </div>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-semibold">Idioma del texto</label>
            <select name="idioma" class="form-select" required>
              <option value="">Seleccionar idioma...</option>
              <option value="es">Espa√±ol</option>
              <option value="en">Ingl√©s</option>
              <option value="ru">Ruso</option>
              <option value="zh">Chino</option>
              <option value="ar">√Årabe</option>
            </select>
          </div>

          <div class="col-md-3 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">
              <i class="fas fa-bolt me-1"></i> Procesar
            </button>
          </div>
        </div>
      </form>

      <div id="loader" class="text-center mt-4" style="display:none;">
        <div class="spinner-border text-info"></div>
        <p class="mt-2 text-white">Procesando an√°lisis...</p>
      </div>

      <div id="error-message" class="text-danger mt-3"></div>
    </div>

    <!-- Resultados -->
    <div id="progreso" class="text-center mt-4"></div>
    <div id="resultado" class="card p-4 mt-3" style="display:none;"></div>

    <div class="text-center mt-4" id="btnPDFContainer" style="display:none;">
      <button id="btnEnviarPDF" class="btn btn-success">
        <i class="fas fa-file-pdf"></i> Enviar reporte PDF por correo
      </button>
    </div>
  </main>

  <footer>¬© 2025 Universidad Mariano G√°lvez ‚Äî Proyecto Final Lenguajes Formales y Aut√≥matas</footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_URL = window.location.origin.includes("localhost")
      ? "http://localhost:3000"
      : "https://reconocimientoguatemala.org";

    let ultimoResultado = null;
    let usuarioActual = null;

    // ==============================
    // üß† Cargar sesi√≥n del usuario
    // ==============================
    document.addEventListener("DOMContentLoaded", () => {
      const sesion = sessionStorage.getItem("sesionActiva");
      const infoUsuario = document.getElementById("info-usuario");

      if (!sesion) {
        alert("‚ö†Ô∏è No hay sesi√≥n activa. Inicie sesi√≥n primero.");
        window.location.href = "home.html";
        return;
      }

      try {
        usuarioActual = JSON.parse(sesion);
        infoUsuario.style.display = "block";
        infoUsuario.innerHTML = `‚úÖ Bienvenido <b>${usuarioActual.nombre_completo}</b> ‚Äî <i>${usuarioActual.correo || usuarioActual.email}</i>`;
      } catch {
        window.location.href = "home.html";
      }
    });

    // ==============================
    // üö™ Cerrar sesi√≥n
    // ==============================
    document.getElementById("btnLogout").addEventListener("click", () => {
      if (confirm("¬øSeguro que deseas cerrar sesi√≥n?")) {
        sessionStorage.removeItem("sesionActiva");
        window.location.href = "home.html";
      }
    });

    // ==============================
    // üöÄ Procesar archivo .txt
    // ==============================
    const form = document.getElementById("formAnalisis");
    const loader = document.getElementById("loader");
    const resultado = document.getElementById("resultado");
    const progreso = document.getElementById("progreso");
    const btnPDFContainer = document.getElementById("btnPDFContainer");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const archivo = form.querySelector('input[name="archivo"]').files[0];
      const idioma = form.querySelector('select[name="idioma"]').value;
      if (!archivo || !idioma) return alert("‚ö†Ô∏è Complete los campos.");

      loader.style.display = "block";
      resultado.style.display = "none";
      progreso.innerHTML = "";
      btnPDFContainer.style.display = "none";

      const formData = new FormData(form);
      try {
        const resp = await fetch(`${API_URL}/analizar`, { method: "POST", body: formData });
        const data = await resp.json();
        loader.style.display = "none";

        if (!data || data.error) {
          resultado.style.display = "block";
          resultado.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${data.error || "Error en el servidor"}</div>`;
          return;
        }

        ultimoResultado = data;
        resultado.style.display = "block";
        btnPDFContainer.style.display = "block";

        resultado.innerHTML = `
          <h4 class="text-center text-info mb-3">üìà Resultados del An√°lisis</h4>
          <p><b>Idioma:</b> ${data.idioma}</p>
          <p><b>Total de palabras:</b> ${data.totalPalabras}</p>
          <p><b>Total de caracteres:</b> ${data.totalCaracteres}</p>

          <h5 class="mt-3">üîù Palabras m√°s frecuentes:</h5>
          <ul>${data.topPalabras.map(([p, c]) => `<li>${p} ‚Äî ${c}</li>`).join("")}</ul>

          <h5>üí¨ Pronombres:</h5>
          <p>${data.pronombres?.slice(0, 30).join(", ") || "‚Äî"}</p>

          <h5>üë§ Personas detectadas:</h5>
          <p>${data.personas?.slice(0, 20).join(", ") || "‚Äî"}</p>

          <h5>üìç Lugares:</h5>
          <p>${data.lugares?.slice(0, 20).join(", ") || "‚Äî"}</p>

          <h5>üß© Verbos:</h5>
          <p>${data.verbos?.slice(0, 40).join(", ") || "‚Äî"}</p>

          <h5>üìò Sustantivos:</h5>
          <p>${data.sustantivos?.slice(0, 40).join(", ") || "‚Äî"}</p>

          <hr>
          <details class="mt-3">
            <summary class="text-light">üìú Ver texto analizado</summary>
            <pre style="max-height:300px;overflow:auto;background:rgba(0,0,0,0.2);padding:10px;border-radius:8px;">
${data.texto.slice(0, 3000)}${data.texto.length > 3000 ? "\n... [Texto truncado]" : ""}
            </pre>
          </details>
        `;
        progreso.innerHTML = `<div class="text-success mt-3">‚úÖ An√°lisis completado correctamente</div>`;
      } catch (err) {
        console.error("Error analizando:", err);
        loader.style.display = "none";
        resultado.style.display = "block";
        resultado.innerHTML = `<div class="alert alert-danger">‚ùå Error de conexi√≥n con el servidor.</div>`;
      }
    });

    // ==============================
    // üì© Enviar PDF completo por correo
    // ==============================
    document.getElementById("btnEnviarPDF").addEventListener("click", async () => {
      if (!usuarioActual || !ultimoResultado) {
        alert("‚ö†Ô∏è Primero realice un an√°lisis y aseg√∫rese de haber iniciado sesi√≥n.");
        return;
      }

      try {
        const resp = await fetch(`${API_URL}/enviar-pdf`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            correo: usuarioActual.correo || usuarioActual.email,
            nombre: usuarioActual.nombre_completo || usuarioActual.nombre || "Usuario",
            resultado: ultimoResultado
          })
        });

        const data = await resp.json();
        if (data.exito) {
          alert("‚úÖ Reporte enviado correctamente a " + (usuarioActual.correo || usuarioActual.email));
        } else {
          alert("‚ùå Error al enviar el PDF: " + data.error);
        }
      } catch (err) {
        console.error("Error enviando PDF:", err);
        alert("‚ùå No se pudo conectar con el servidor.");
      }
    });
  </script>
</body>
</html>
