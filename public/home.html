<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UMG | Iniciar Sesi√≥n</title>
  <base href="/"> <!-- ‚úÖ fuerza rutas absolutas -->

  <!-- üß© Dependencias -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
    rel="stylesheet" />
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    :root {
      --azul: #003366;
      --azul-oscuro: #001b33;
      --cian: #00e0ff;
      --dorado: #c5a200;
      --fondo: linear-gradient(135deg, #001b33, #004b8d);
    }

    body {
      font-family: "Poppins", sans-serif;
      background: var(--fondo);
      background-size: 400% 400%;
      animation: fondoAnimado 12s ease infinite;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      overflow: hidden;
    }

    @keyframes fondoAnimado {

      0%,
      100% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }
    }

    .card-login {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 24px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.35);
      padding: 3rem;
      max-width: 420px;
      width: 100%;
      text-align: center;
      animation: fadeSlide 1s ease;
      backdrop-filter: blur(8px);
    }

    @keyframes fadeSlide {
      from {
        opacity: 0;
        transform: translateY(40px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card-login img {
      width: 90px;
      margin-bottom: 15px;
      animation: logoPulse 3s infinite ease-in-out;
    }

    @keyframes logoPulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }
    }

    h2 {
      color: var(--azul);
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .form-control {
      border-radius: 12px;
      border: 1px solid #ccc;
      padding: 10px 14px;
      transition: all 0.25s;
    }

    .form-control:focus {
      border-color: var(--azul);
      box-shadow: 0 0 0 4px rgba(0, 51, 102, 0.15);
    }

    .btn {
      width: 100%;
      font-weight: 600;
      border-radius: 12px;
      padding: 10px;
      margin-top: 10px;
      transition: all 0.3s ease;
    }

    .btn-login {
      background: var(--azul);
      color: white;
    }

    .btn-login:hover {
      background: var(--azul-oscuro);
      transform: translateY(-2px);
    }

    .btn-qr {
      background: #198754;
      color: white;
    }

    .btn-face {
      background: #212529;
      color: white;
    }

    .btn-qr:hover {
      background: #157347;
      transform: translateY(-2px);
    }

    .btn-face:hover {
      background: black;
      transform: translateY(-2px);
    }

    .divider {
      border-top: 1px solid #ccc;
      margin: 1.5rem 0;
    }
  </style>
</head>

<body>
  <div class="card-login shadow-lg">
    <img src="img/logo_umg.png" alt="Logo UMG" />
    <h2><i class="fas fa-user-graduate me-2"></i>Portal de Acceso</h2>
    <p class="text-muted mb-3">Ingrese sus credenciales para continuar</p>

    <!-- üßæ FORMULARIO -->
    <form id="login-form" novalidate>
      <div class="mb-3 text-start">
        <label for="correo" class="form-label">Correo Electr√≥nico</label>
        <input type="email" id="correo" class="form-control" placeholder="ejemplo@correo.com" required />
      </div>

      <div class="mb-3 text-start">
        <label for="password" class="form-label">Contrase√±a</label>
        <input type="password" id="password" minlength="6" class="form-control" placeholder="Ingresa tu contrase√±a"
          required />
      </div>

      <div class="mb-3 text-center">
        <div class="g-recaptcha" data-sitekey="6LfZ8_QrAAAAAL1DTEdy_MQg-tlZHgyI7_OTtgMb"></div>
      </div>

      <button type="submit" id="btn-login" class="btn btn-login">
        <i class="fas fa-sign-in-alt me-2"></i> Ingresar
      </button>
    </form>

    <div class="divider"></div>

    <button id="qr-login" class="btn btn-qr">
      <i class="fas fa-qrcode me-2"></i> Ingresar con QR
    </button>

    <button id="face-login" class="btn btn-face">
      <i class="fas fa-camera me-2"></i> Ingresar con Rostro
    </button>

    <p class="mt-3 mb-0">
      ¬øNo tienes cuenta?
      <a href="registro.html" class="fw-semibold text-primary">Reg√≠strate aqu√≠</a>
    </p>
  </div>

  <!-- üß† Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1055">
    <div id="toast" class="toast align-items-center text-bg-primary border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toast-body">...</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>
  <!-- üß© Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js/dist/face-api.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js/dist/face-api.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <script>
    const toastEl = document.getElementById('toast');
    const toastBody = document.getElementById('toast-body');
    const toast = new bootstrap.Toast(toastEl);

    function showToast(msg, type = "info") {
      toastEl.className = `toast align-items-center text-bg-${type} border-0`;
      toastBody.textContent = msg;
      toast.show();
    }

    // ============================
    // üëÅÔ∏è LOGIN FACIAL
    // ============================
    const faceBtn = document.getElementById("face-login");
    let faceModelsLoaded = false, currentStream = null;

    faceBtn.addEventListener("click", async () => {
      try {
        showToast("üß† Cargando modelos de reconocimiento...", "info");
        if (!faceModelsLoaded) {
          await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri("/faceapi_models/tiny_face_detector/"),
            faceapi.nets.faceRecognitionNet.loadFromUri("/faceapi_models/face_recognition/"),
            faceapi.nets.faceLandmark68Net.loadFromUri("/faceapi_models/face_landmark_68/"),
            faceapi.nets.ssdMobilenetv1.loadFromUri("/faceapi_models/ssd_mobilenetv1/")
          ]);
          faceModelsLoaded = true;
        }

        showToast("üì∑ Modelos listos, iniciando c√°mara...", "success");

        const modal = document.createElement("div");
        modal.innerHTML = `
        <div id="face-modal" style="position:fixed;top:0;left:0;width:100%;height:100%;
          background:rgba(0,0,0,0.85);display:flex;flex-direction:column;
          justify-content:center;align-items:center;z-index:9999;">
          <video id="videoFace" autoplay muted playsinline style="width:320px;height:240px;
            border:3px solid #00e0ff;border-radius:12px;"></video>
          <div id="loadingCircle" style="width:60px;height:60px;border:4px solid #00e0ff;
            border-top:4px solid transparent;border-radius:50%;margin-top:15px;
            animation:spin 1s linear infinite;"></div>
          <button id="cerrarFace" class="btn btn-danger mt-3"><i class="fas fa-xmark"></i> Cerrar</button>
        </div>
        <style>@keyframes spin{100%{transform:rotate(360deg);}}</style>`;
        document.body.appendChild(modal);

        const video = document.getElementById("videoFace");
        currentStream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = currentStream;

        const detectionInterval = setInterval(async () => {
          const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
          if (detections) {
            showToast("‚úÖ Rostro detectado, verificando...", "success");
            clearInterval(detectionInterval);
            const canvas = faceapi.createCanvasFromMedia(video);
            const blob = await new Promise(res => canvas.toBlob(res, "image/jpeg"));
            const formData = new FormData();
            formData.append("rostro", blob, "rostro.jpg");

            const res = await fetch("/api/login-face", { method: "POST", body: formData });
            const data = await res.json();
            await stopCamera();

            if (res.ok && data.success) {
              showToast(`‚úÖ Bienvenido ${data.usuario.nombre_completo}`, "success");
              sessionStorage.setItem("sesionActiva", JSON.stringify(data.usuario));
              setTimeout(() => window.location.href = "analizador.html", 1500);
            } else {
              showToast(`‚ùå ${data.message || "Rostro no reconocido."}`, "danger");
            }
          }
        }, 2000);

        document.getElementById("cerrarFace").addEventListener("click", async () => {
          clearInterval(detectionInterval);
          await stopCamera();
        });

        async function stopCamera() {
          if (currentStream) currentStream.getTracks().forEach(t => t.stop());
          const modal = document.getElementById("face-modal");
          if (modal) modal.remove();
        }

      } catch (e) {
        console.error("Error detallado en login facial:", e);
        if (e.name === "NotAllowedError") showToast("üö´ Acceso a la c√°mara denegado.", "danger");
        else if (e.name === "NotFoundError") showToast("üì∑ No se encontr√≥ ninguna c√°mara.", "warning");
        else showToast("‚ö†Ô∏è Error inesperado: " + e.message, "warning");
      }
    });
  </script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
document.getElementById("qr-login").addEventListener("click", async () => {
  try {
    const modal = document.createElement("div");
    modal.innerHTML = `
      <div id="qr-modal" style="
        position:fixed;top:0;left:0;width:100%;height:100%;
        background:rgba(0,0,0,0.9);display:flex;flex-direction:column;
        justify-content:center;align-items:center;z-index:9999;">
        <div id="qr-reader" style="width:320px;height:320px;"></div>
        <button id="cerrarQR" class="btn btn-danger mt-3">Cerrar</button>
      </div>`;
    document.body.appendChild(modal);

    const html5QrCode = new Html5Qrcode("qr-reader");
    const cameras = await Html5Qrcode.getCameras();
    if (!cameras || cameras.length === 0)
      throw new Error("No se encontr√≥ c√°mara");

    const qrSuccessCallback = async (decodedText) => {
      console.log("üì∏ QR detectado:", decodedText);

      if (!decodedText || decodedText.trim() === "") {
        showToast("‚ö†Ô∏è QR vac√≠o o ilegible", "warning");
        return;
      }

      // üîç Extrae solo el c√≥digo si el QR contiene una URL
      let valorQR = decodedText.trim();
      const match = valorQR.match(/[?&]codigo=([^&]+)/);
      if (match) valorQR = decodeURIComponent(match[1]);

      showToast("üîç Verificando QR...", "info");

      await html5QrCode.stop();
      document.getElementById("qr-modal").remove();

      console.log("üöÄ Enviando al servidor:", valorQR);

      const res = await fetch("/api/login-qr", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ codigo: valorQR })
      });

      const data = await res.json();
      if (res.ok && data.success) {
        showToast(`‚úÖ Bienvenido ${data.usuario.nombre_completo}`, "success");
        sessionStorage.setItem("sesionActiva", JSON.stringify(data.usuario));
        setTimeout(() => window.location.href = "analizador.html", 1500);
      } else {
        showToast(`‚ùå ${data.message || "QR no v√°lido"}`, "danger");
      }
    };

    await html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, qrSuccessCallback);
    document.getElementById("cerrarQR").addEventListener("click", async () => {
      await html5QrCode.stop();
      document.getElementById("qr-modal").remove();
    });
  } catch (e) {
    console.error("Error en login QR:", e);
    showToast("‚ö†Ô∏è No se pudo iniciar el lector QR: " + e.message, "danger");
  }
});
</script>
<script>
document.getElementById("login-form").addEventListener("submit", async (e) => {
  e.preventDefault();

  const correo = document.getElementById("correo").value.trim();
  const password = document.getElementById("password").value.trim();
  const captchaToken = grecaptcha.getResponse();

  if (!correo || !password) {
    showToast("‚ö†Ô∏è Ingrese su correo y contrase√±a.", "warning");
    return;
  }
  if (!captchaToken) {
    showToast("‚ö†Ô∏è Verifique el reCAPTCHA.", "warning");
    return;
  }

  try {
    showToast("üîç Verificando credenciales...", "info");
    const res = await fetch("/api/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        correo,
        password,
        "g-recaptcha-response": captchaToken
      })
    });

    const data = await res.json();
    if (res.ok && data.success) {
      showToast(`‚úÖ Bienvenido ${data.usuario.nombre_completo}`, "success");
      sessionStorage.setItem("sesionActiva", JSON.stringify(data.usuario));
      setTimeout(() => window.location.href = "analizador.html", 1500);
    } else {
      showToast(`‚ùå ${data.message || "Error de autenticaci√≥n"}`, "danger");
    }
  } catch (error) {
    console.error("Error al iniciar sesi√≥n:", error);
    showToast("‚ö†Ô∏è Error interno del servidor", "danger");
  }
});
</script>


</body>

</html>